<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Order Target Indicators</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error-row { background-color: #ffebee; }
        .form-inline { display: inline; }
        .hidden { display: none; }
    </style>
</head>
<body>
<h1>Приказ #1:Целевые показатели (проверка XLS)</h1>
<div id="message" style="color: green;" class="hidden"></div>
<div id="transferMessage" style="color: red;" class="hidden"></div>

<form id="uploadForm" action="/api/order/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".xlsx" required>
    <button type="submit">Добавить XLS (к текущему списку)</button>
</form>

<h2>Main Indicators</h2>
<button onclick="clearList()">Очистить список экрана</button>
<table id="mainTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Номер</th>
        <th>Структура</th>
        <th>Цель</th>
        <th>Срок</th>
        <th>Дивизион</th>
        <th>Координатор</th>
        <th>Ответственные</th>
        <th>Дополнительные ответственные</th>
        <th>Действия</th>
    </tr>
    </thead>
    <tbody id="mainTableBody">
    <!-- Данные будут загружаться через JavaScript -->
    </tbody>
</table>
<a href="/api/order/export/main">Сохранить XLS</a>

<h2>Ошибки XLS файла</h2>

<form id="transferForm" action="/api/order/transfer" method="post">
    <table id="errorTable">
        <thead>
        <tr>
            <th>Select</th>
            <th>ID</th>
            <th>Номер</th>
            <th>Структура</th>
            <th>Цель</th>
            <th>Срок</th>
            <th>Дивизион</th>
            <th>Координатор</th>
            <th>Ответственные</th>
            <th>Доп. ответственные</th>
            <th>Причина ошибки</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="errorTableBody">
        <!-- Данные будут загружаться через JavaScript -->
        </tbody>
    </table>
    <button type="submit">Перенести выбранные в основной экран</button>
</form>
<a href="/api/order/export/errors">Сохранить ошибки в XLS</a>
<a href="/api/order/errors">Страница просмотра ошибок</a>

<script>
    // Глобальные переменные для данных
    let indicators = [];
    let errors = [];
    let structures = [];
    let divisions = [];

    // Загрузка данных при старте
    document.addEventListener('DOMContentLoaded', function() {
        loadInitialData();
        setupEventListeners();
    });

    function loadInitialData() {
        // Загружаем данные с сервера
        fetch('/api/order/data')
            .then(response => response.json())
            .then(data => {
                indicators = data.indicators || [];
                errors = data.errors || [];
                structures = data.structures || [];
                divisions = data.divisions || [];

                renderMainTable();
                renderErrorTable();

                // Показываем сообщения, если есть
                if (data.message) {
                    showMessage(data.message, 'message');
                }
                if (data.transferMessage) {
                    showMessage(data.transferMessage, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    }

    function setupEventListeners() {
        // Обработчик для формы загрузки файла
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFile(this);
        });

        // Обработчик для формы переноса ошибок
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            transferErrors(this);
        });
    }

    function renderMainTable() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';

        indicators.forEach(indicator => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${indicator.id}</td>
            <td><input type="text" name="number" value="${indicator.number || ''}"></td>
            <td>
                <select name="structure">
                    ${renderOptions(structures, indicator.structure)}
                </select>
            </td>
            <td><input type="text" name="goal" value="${indicator.goal || ''}"></td>
            <td><input type="text" name="deadline" value="${indicator.deadline || ''}"></td>
            <td>
                <select name="division">
                    ${renderOptions(divisions, indicator.division)}
                </select>
            </td>
            <td><input type="text" name="coordinator" value="${indicator.coordinator || ''}"></td>
            <td><input type="text" name="responsibles" value="${indicator.responsibles || ''}"></td>
            <td><input type="text" name="additionalResponsibles" value="${indicator.additionalResponsibles || ''}"></td>
            <td>
                <button onclick="updateIndicator(${indicator.id}, this.parentNode.parentNode)">Обновить</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function renderErrorTable() {
        const tbody = document.getElementById('errorTableBody');
        tbody.innerHTML = '';

        errors.forEach(error => {
            const row = document.createElement('tr');
            row.className = 'error-row';
            row.innerHTML = `
            <td><input type="checkbox" name="errorIds" value="${error.id}"></td>
            <td>${error.id}</td>
            <td><input type="text" name="number" value="${error.number || ''}"></td>
            <td>
                <select name="structure">
                    ${renderOptions(structures, error.structure)}
                </select>
            </td>
            <td><input type="text" name="goal" value="${error.goal || ''}"></td>
            <td><input type="text" name="deadline" value="${error.deadline || ''}"></td>
            <td>
                <select name="division">
                    ${renderOptions(divisions, error.division)}
                </select>
            </td>
            <td><input type="text" name="coordinator" value="${error.coordinator || ''}"></td>
            <td><input type="text" name="responsibles" value="${error.responsibles || ''}"></td>
            <td><input type="text" name="additionalResponsibles" value="${error.additionalResponsibles || ''}"></td>
            <td>${error.errorReason || ''}</td>
            <td>
                <button onclick="updateError(${error.id}, this.parentNode.parentNode)">Обновить</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function renderOptions(options, selectedValue) {
        return options.map(option => {
            const selected = option === selectedValue ? 'selected' : '';
            return `<option value="${option}" ${selected}>${option}</option>`;
        }).join('');
    }

    function updateIndicator(id, row) {
        const formData = new FormData();
        formData.append('number', row.querySelector('input[name="number"]').value);
        formData.append('structure', row.querySelector('select[name="structure"]').value);
        formData.append('goal', row.querySelector('input[name="goal"]').value);
        formData.append('deadline', row.querySelector('input[name="deadline"]').value);
        formData.append('division', row.querySelector('select[name="division"]').value);
        formData.append('coordinator', row.querySelector('input[name="coordinator"]').value);
        formData.append('responsibles', row.querySelector('input[name="responsibles"]').value);
        formData.append('additionalResponsibles', row.querySelector('input[name="additionalResponsibles"]').value);

        fetch(`/api/order/update/${id}`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные успешно обновлены', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при обновлении данных: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при обновлении данных', 'transferMessage');
            });
    }

    function updateError(id, row) {
        const formData = new FormData();
        formData.append('number', row.querySelector('input[name="number"]').value);
        formData.append('structure', row.querySelector('select[name="structure"]').value);
        formData.append('goal', row.querySelector('input[name="goal"]').value);
        formData.append('deadline', row.querySelector('input[name="deadline"]').value);
        formData.append('division', row.querySelector('select[name="division"]').value);
        formData.append('coordinator', row.querySelector('input[name="coordinator"]').value);
        formData.append('responsibles', row.querySelector('input[name="responsibles"]').value);
        formData.append('additionalResponsibles', row.querySelector('input[name="additionalResponsibles"]').value);

        fetch(`/api/order/update-error/${id}`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные ошибки успешно обновлены', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при обновлении данных ошибки: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при обновлении данных ошибки', 'transferMessage');
            });
    }

    function uploadFile(form) {
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Файл успешно загружен', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при загрузке файла: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при загрузке файла', 'transferMessage');
            });
    }

    function transferErrors(form) {
        // const formData = new FormData(form);
        const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');

        if (checkboxes.length === 0) {
            showMessage('Выберите хотя бы одну ошибку для переноса', 'transferMessage');
            return;
        }
        const errorIds = Array.from(checkboxes).map(checkbox => checkbox.value);
        // checkboxes.forEach(checkbox => {
        //     formData.append('errorIds', checkbox.value);
        // });

        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(errorIds)
            // body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные успешно перенесены', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при переносе данных: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при переносе данных', 'transferMessage');
            });
    }

    function clearList() {
        fetch('/api/order/clear', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Список очищен', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при очистке списка: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при очистке списка', 'transferMessage');
            });
    }

    function showMessage(text, elementId) {
        const element = document.getElementById(elementId);
        element.textContent = text;
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 5000);
    }
</script>

</body>
</html>
