<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Order Target Indicators</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error-row { background-color: #ffebee; }
        .form-inline { display: inline; }
        .hidden { display: none; }

        .number-col { width: 3%; min-width: 70px; }
        .level-col { width: 3%; min-width: 70px; }
        .goal-col { width: 30%; min-width: 300px; }
        .structure-col { width: 8%; min-width: 120px; }
        .deadline-col { width: 5%; min-width: 100px; }
        .deadlineend-col { width: 5%; min-width: 100px; }
        .division-col { width: 8%; min-width: 140px; }
        .owner-col { width: 8%; min-width: 140px; }
        .coordinator-col { width: 8%; min-width: 140px; }
        .responsibles-col { width: 10%; min-width: 160px; }
        .additional-responsibles-col { width: 10%; min-width: 160px; }
        .business-col { width: 8%; min-width: 140px; }
        .actions-col { width: 5%; min-width: 100px; }

        /* Для таблицы ошибок добавлены дополнительные колонки */
        .error-reason-col { width: 15%; min-width: 200px; }
        .error-select-col { width: 3%; min-width: 50px; }

        /* Стили для input и select внутри ячеек */
        td input[type="text"],
        td select {
            width: 100%;
            box-sizing: border-box;
        }

        /* Стили для множественного выбора */
        select[multiple] {
            min-height: 100px;
        }
    </style>
</head>
<body>
<h1>Приказ #1:Целевые показатели (проверка XLS)</h1>
<div id="message" style="color: green;" class="hidden"></div>
<div id="transferMessage" style="color: red;" class="hidden"></div>

<form id="uploadForm" action="/api/order/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".xlsx" required>
    <button type="submit">Добавить XLS (к текущему списку)</button>
</form>

<h2>Main Indicators</h2>
<button onclick="clearList()">Очистить список экрана</button>
<table id="mainTable">
    <thead>
    <tr>
        <th class="number-col">ID</th>
        <th class="number-col">Номер</th>
        <th class="structure-col">Структура</th>
        <th class="level-col">Уровень</th>
        <th class="goal-col">Цель</th>
        <th class="deadline-col">Дата_старт</th>
        <th class="deadlineend-col">Дата_стоп</th>
        <th class="coordinator-col">Координатор</th>
        <th class="division-col">Дивизион</th>
        <th class="owner-col">Владелец</th>
        <th class="responsibles-col">Соисполнители</th>
        <th class="additional-responsibles-col">Доп. ответственные</th>
        <th class="business-col">Бизнес</th>
        <th class="actions-col">Действия</th>
    </tr>
    </thead>
    <tbody id="mainTableBody">
    <!-- Данные будут загружаться через JavaScript -->
    </tbody>
</table>
<a href="/api/order/export/main">Сохранить XLS</a>

<h2>Ошибки XLS файла</h2>
<button onclick="clearListErr()">Очистить список экрана</button>
<form id="transferForm" action="/api/order/transfer" method="post">
    <table id="errorTable">
        <thead>
        <tr>
            <th class="error-select-col">Select</th>
            <th class="number-col">ID</th>
            <th class="number-col">Номер</th>
            <th class="structure-col">Структура</th>
            <th class="level-col">Уровень</th>
            <th class="goal-col">Цель</th>
            <th class="deadline-col">Дата_старт</th>
            <th class="deadlineend-col">Дата_стоп</th>
            <th class="coordinator-col">Координатор</th>
            <th class="division-col">Дивизион</th>
            <th class="owner-col">Владелец</th>
            <th class="responsibles-col">Соисполнители</th>
            <th class="additional-responsibles-col">Доп. ответственные</th>
            <th class="business-col">Бизнес</th>
            <th class="error-reason-col">Причина ошибки</th>
            <th class="actions-col">Действия</th>
        </tr>
        </thead>
        <tbody id="errorTableBody">
        <!-- Данные будут загружаться через JavaScript -->
        </tbody>
    </table>
    <button type="submit">Перенести выбранные в основной экран</button>
</form>
<a href="/api/order/export/errors">Сохранить ошибки в XLS</a>
<a href="/api/order/errors">Страница просмотра ошибок</a>

<script>
    // Глобальные переменные для данных
    let indicators = [];
    let errors = [];
    let structures = [];
    let divisions = [];

    // Загрузка данных при старте
    document.addEventListener('DOMContentLoaded', function() {
        loadInitialData();
        setupEventListeners();
    });

    function loadInitialData() {
        // Загружаем данные с сервера
        fetch('/api/order/data')
            .then(response => response.json())
            .then(data => {
                indicators = data.indicators || [];
                errors = data.errors || [];
                structures = data.structures || [];
                divisions = data.divisions || [];

                renderMainTable();
                renderErrorTable();

                // Показываем сообщения, если есть
                if (data.message) {
                    showMessage(data.message, 'message');
                }
                if (data.transferMessage) {
                    showMessage(data.transferMessage, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    }

    function setupEventListeners() {
        // Обработчик для формы загрузки файла
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFile(this);
        });

        // Обработчик для формы переноса ошибок
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            transferErrors(this);
        });
    }

    function renderMainTable() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';

        indicators.forEach(indicator => {
            const row = document.createElement('tr');

            // Отладка: проверьте, что такое divisions для indicator
            console.log('Indicator divisions:', indicator.divisions, typeof indicator.divisions);

            let divisionArray = [];
            if (indicator.divisions) {
                if (Array.isArray(indicator.divisions)) {
                    // Если массив объектов, извлеките имена (предполагая поле name)
                    divisionArray = indicator.divisions.map(d => {
                        if (typeof d === 'string') return d;
                        return d.displayName || d.value || d.toString(); // Адаптируйте под поля Division
                    });
                    console.log('Division array:', divisionArray);
                } else if (typeof indicator.divisions === 'string') {
                    divisionArray = indicator.divisions.split(/[,;]+/).map(d => d.trim()).filter(d => d);
                    console.log('Division array String:', divisionArray);
                } else {
                    console.warn('Indicator divisions не является массивом или строкой:', indicator.divisions);
                }
            }

            row.innerHTML = `
            <td>${indicator.id}</td>
            <td><input type="text" name="number" value="${indicator.number || ''}"></td>
            <td>
                <select name="structure">
                    ${renderOptions(structures, indicator.structure)}
                </select>
            </td>
            <td><input type="text" name="level" value="${indicator.level || ''}"></td>
            <td><input type="text" name="goal" value="${indicator.goal || ''}"></td>
            <td><input type="text" name="deadline" value="${indicator.deadline || ''}"></td>
            <td><input type="text" name="deadlineEnd" value="${indicator.deadlineEnd || ''}"></td>
            <td><input type="text" name="coordinator" value="${indicator.coordinator || ''}"></td>
            <td>
                <select name="divisions" multiple>
                    ${renderMultipleOptions(divisions, divisionArray)}
                </select>
            </td>
            <td><input type="text" name="owner" value="${indicator.owner || ''}"></td>
            <td><input type="text" name="responsibles" value="${indicator.responsibles || ''}"></td>
            <td><input type="text" name="additionalResponsibles" value="${indicator.additionalResponsibles || ''}"></td>
            <td><input type="text" name="business" value="${indicator.business || ''}"></td>
            <td>
                <button onclick="updateIndicator(${indicator.id}, this.parentNode.parentNode)">Обновить</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function renderErrorTable() {
        const tbody = document.getElementById('errorTableBody');
        tbody.innerHTML = '';

        errors.forEach(error => {
            const row = document.createElement('tr');
            row.className = 'error-row';

            // Отладка: проверьте, что такое divisions для error
            console.log('Error divisions:', error.divisions, typeof error.divisions);

            let divisionArray = [];

            if (error.divisions) {
                if (Array.isArray(error.divisions)) {
                    // Если массив объектов, извлеките имена (предполагая поле name)
                    divisionArray = error.divisions.map(d => {
                        if (typeof d === 'string') return d;
                        return d.displayName || d.value || d.toString(); // Адаптируйте под поля Division
                    });
                    console.log('Division array:', divisionArray);
                } else if (typeof error.divisions === 'string') {
                    divisionArray = error.divisions.split(/[,;]+/).map(d => d.trim()).filter(d => d);
                    console.log('Division array String:', divisionArray);
                } else {
                    console.warn('Indicator divisions не является массивом или строкой:', indicator.divisions);
                }
            }
            row.innerHTML = `
            <td><input type="checkbox" name="errorIds" value="${error.id}"></td>
            <td>${error.id}</td>
            <td><input type="text" name="number" value="${error.number || ''}"></td>
            <td>
                <select name="structure">
                    ${renderOptions(structures, error.structure)}
                </select>
            </td>
            <td><input type="text" name="level" value="${error.level || ''}"></td>
            <td><input type="text" name="goal" value="${error.goal || ''}"></td>
            <td><input type="text" name="deadline" value="${error.deadline || ''}"></td>
            <td><input type="text" name="deadlineEnd" value="${error.deadlineEnd || ''}"></td>
            <td><input type="text" name="coordinator" value="${error.coordinator || ''}"></td>
            <td>
                <select name="divisions" multiple>
                    ${renderMultipleOptions(divisions, divisionArray)}
                </select>
            </td>
            <td><input type="text" name="owner" value="${error.owner || ''}"></td>
            <td><input type="text" name="responsibles" value="${error.responsibles || ''}"></td>
            <td><input type="text" name="additionalResponsibles" value="${error.additionalResponsibles || ''}"></td>
            <td><input type="text" name="business" value="${error.business || ''}"></td>
            <td>${error.errorMessage || ''}</td>
            <td>
                <button onclick="updateError(${error.id}, this.parentNode.parentNode)">Обновить</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }


    function renderOptions(options, selectedValue) {
        return options.map(option => {
            const selected = option === selectedValue ? 'selected' : '';
            return `<option value="${option}" ${selected}>${option}</option>`;
        }).join('');
    }

    function renderMultipleOptions(options, selectedValues) {
        if (!Array.isArray(selectedValues)) {
            selectedValues = [];
        }
        return options.map(option => {
            const optionValue = option.displayName || option.value || option.toString();
            const selected = selectedValues.includes(optionValue) ? 'selected' : '';
            return `<option value="${optionValue}" ${selected}>${optionValue}</option>`;
        }).join('');
    }

    function updateIndicator(id, row) {
        // Получаем все выбранные значения из множественного select
        const divisionSelect = row.querySelector('select[name="divisions"]');
        const selectedDivisions = Array.from(divisionSelect.selectedOptions)
            .map(option => option.value)
            .join(', ');

        const data = {
            number: row.querySelector('input[name="number"]').value,
            structure: row.querySelector('select[name="structure"]').value || '',
            level: row.querySelector('input[name="level"]').value || '',
            goal: row.querySelector('input[name="goal"]').value,
            deadline: row.querySelector('input[name="deadline"]').value || '',
            deadlineEnd: row.querySelector('input[name="deadlineEnd"]').value || '',
            coordinator: row.querySelector('input[name="coordinator"]').value || '',
            divisions: selectedDivisions, // Отправляем строку с разделителями
            owner: row.querySelector('input[name="owner"]').value || '',
            responsibles: row.querySelector('input[name="responsibles"]').value || '',
            additionalResponsibles: row.querySelector('input[name="additionalResponsibles"]').value || '',
            business: row.querySelector('input[name="business"]').value || ''
        };

        fetch(`/api/order/update/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные успешно обновлены', 'message');
                    loadInitialData();
                } else {
                    showMessage('Ошибка при обновлении данных: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при обновлении данных', 'transferMessage');
            });
    }

    function updateError(id, row) {
        // Получаем все выбранные значения из множественного select
        const divisionSelect = row.querySelector('select[name="divisions"]');
        const selectedDivisions = Array.from(divisionSelect.selectedOptions)
            .map(option => option.value)
            .join(', ');

        const data = {
            number: row.querySelector('input[name="number"]').value,
            structure: row.querySelector('select[name="structure"]').value || '',
            level: row.querySelector('input[name="level"]').value || '',
            goal: row.querySelector('input[name="goal"]').value,
            deadline: row.querySelector('input[name="deadline"]').value || '',
            deadlineEnd: row.querySelector('input[name="deadlineEnd"]').value || '',
            coordinator: row.querySelector('input[name="coordinator"]').value || '',
            divisions: selectedDivisions, // Отправляем строку с разделителями
            owner: row.querySelector('input[name="owner"]').value || '',
            responsibles: row.querySelector('input[name="responsibles"]').value || '',
            additionalResponsibles: row.querySelector('input[name="additionalResponsibles"]').value || '',
            business: row.querySelector('input[name="business"]').value  || ''
        };

        fetch(`/api/order/update-error/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные ошибки успешно обновлены', 'message');
                    loadInitialData();
                } else {
                    showMessage('Ошибка при обновлении данных ошибки: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при обновлении данных ошибки', 'transferMessage');
            });
    }

    function uploadFile(form) {
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log('Ответ сервера:', data);
                if (data.success) {
                    showMessage('Файл успешно загружен', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    const message = data.message || 'Неизвестная ошибка';
                    showMessage('Ошибка при загрузке файла: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при загрузке файла', 'transferMessage');
            });
    }

    function transferErrors(form) {
        const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');

        if (checkboxes.length === 0) {
            showMessage('Выберите хотя бы одну ошибку для переноса', 'transferMessage');
            return;
        }
        const errorIds = Array.from(checkboxes).map(checkbox => checkbox.value);

        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(errorIds)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Данные успешно перенесены', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при переносе данных: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при переносе данных', 'transferMessage');
            });
    }

    function clearList() {
        fetch('/api/order/clear', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Список очищен', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при очистке списка: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при очистке списка', 'transferMessage');
            });
    }
    function clearListErr() {
        fetch('/api/order/clearErr', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Список очищен', 'message');
                    loadInitialData(); // Перезагружаем данные
                } else {
                    showMessage('Ошибка при очистке списка: ' + data.message, 'transferMessage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Ошибка при очистке списка', 'transferMessage');
            });
    }
    function showMessage(text, elementId) {
        const element = document.getElementById(elementId);
        element.textContent = text;
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 5000);
    }
</script>

</body>
</html>